# 时光轴笔记本全栈部署解决方案

## 1. 部署概述

本文档提供时光轴笔记本项目的完整部署解决方案，解决Vercel仅支持前端部署导致的API连接问题。

### 1.1 部署架构
- **前端**: Vercel (静态托管)
- **后端**: Railway/Render (Python Flask应用)
- **数据库**: SQLite (文件存储)
- **文件存储**: 后端服务器本地存储

## 2. 后端部署方案

### 2.1 Railway部署 (推荐)

#### 2.1.1 准备工作
1. 注册Railway账号: https://railway.app
2. 连接GitHub仓库
3. 创建项目配置文件

#### 2.1.2 配置文件创建

**创建 `railway.json`**:
```json
{
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "python app.py",
    "restartPolicyType": "ON_FAILURE"
  }
}
```

**创建 `requirements.txt`**:
```txt
Flask==2.3.3
Flask-CORS==4.0.0
Werkzeug==2.3.7
Pillow==10.0.1
python-dotenv==1.0.0
```

**创建 `Procfile`**:
```
web: python app.py
```

#### 2.1.3 环境变量配置
在Railway项目设置中添加:
```
PORT=5000
FLASK_ENV=production
FLASK_DEBUG=False
```

#### 2.1.4 部署步骤
1. 在Railway创建新项目
2. 连接GitHub仓库
3. 选择根目录作为部署目录
4. 配置环境变量
5. 部署并获取域名

### 2.2 Render部署 (备选方案)

#### 2.2.1 准备工作
1. 注册Render账号: https://render.com
2. 连接GitHub仓库

#### 2.2.2 配置文件

**创建 `render.yaml`**:
```yaml
services:
  - type: web
    name: timeline-notebook-backend
    env: python
    buildCommand: pip install -r requirements.txt
    startCommand: python app.py
    envVars:
      - key: PORT
        value: 10000
      - key: FLASK_ENV
        value: production
```

#### 2.2.3 部署步骤
1. 在Render创建Web Service
2. 连接GitHub仓库
3. 配置构建和启动命令
4. 设置环境变量
5. 部署并获取域名

## 3. 前端配置更新

### 3.1 API配置修改

修改前端API配置文件，支持开发和生产环境:

**创建 `frontend/src/config/api.js`**:
```javascript
const API_CONFIG = {
  development: {
    baseURL: 'http://localhost:5000'
  },
  production: {
    baseURL: 'https://your-backend-domain.railway.app' // 替换为实际后端域名
  }
}

const currentEnv = import.meta.env.MODE || 'development'
export const API_BASE_URL = API_CONFIG[currentEnv].baseURL
```

### 3.2 组件API调用更新

更新所有组件中的API调用:

**TimelineComponent.vue**:
```javascript
import { API_BASE_URL } from '@/config/api.js'

// 替换所有API调用
const response = await fetch(`${API_BASE_URL}/api/timeline`)
```

**TimeCapsuleList.vue**:
```javascript
import { API_BASE_URL } from '@/config/api.js'

// 替换所有API调用
const response = await fetch(`${API_BASE_URL}/api/capsules`)
```

### 3.3 环境变量配置

**创建 `frontend/.env.production`**:
```
VITE_API_BASE_URL=https://your-backend-domain.railway.app
```

**创建 `frontend/.env.development`**:
```
VITE_API_BASE_URL=http://localhost:5000
```

## 4. 数据库迁移方案

### 4.1 SQLite数据库处理

由于使用SQLite文件数据库，需要确保:

1. **数据库文件包含在部署中**:
   - 将 `timeline.db` 添加到Git仓库
   - 确保后端有写入权限

2. **数据库初始化脚本**:

**创建 `init_db.py`**:
```python
import sqlite3
import os

def init_database():
    if not os.path.exists('timeline.db'):
        conn = sqlite3.connect('timeline.db')
        cursor = conn.cursor()
        
        # 创建时间轴表
        cursor.execute('''
            CREATE TABLE timeline_entries (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                title TEXT NOT NULL,
                content TEXT NOT NULL,
                date TEXT NOT NULL,
                media_path TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # 创建时光胶囊表
        cursor.execute('''
            CREATE TABLE time_capsules (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                title TEXT NOT NULL,
                content TEXT NOT NULL,
                unlock_date TEXT NOT NULL,
                media_path TEXT,
                is_unlocked BOOLEAN DEFAULT FALSE,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        conn.commit()
        conn.close()
        print("数据库初始化完成")
    else:
        print("数据库已存在")

if __name__ == '__main__':
    init_database()
```

### 4.2 后端应用更新

修改 `app.py` 添加数据库初始化:

```python
from init_db import init_database

if __name__ == '__main__':
    # 初始化数据库
    init_database()
    
    # 启动应用
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=False)
```

## 5. 完整部署流程

### 5.1 后端部署流程

1. **准备后端代码**:
   ```bash
   # 创建必要的配置文件
   touch requirements.txt
   touch railway.json
   touch Procfile
   touch init_db.py
   ```

2. **推送代码到GitHub**:
   ```bash
   git add .
   git commit -m "Add backend deployment configuration"
   git push origin main
   ```

3. **在Railway部署**:
   - 登录Railway控制台
   - 创建新项目
   - 连接GitHub仓库
   - 配置环境变量
   - 等待部署完成
   - 记录分配的域名

4. **测试后端API**:
   ```bash
   curl https://your-backend-domain.railway.app/api/health
   ```

### 5.2 前端部署流程

1. **更新API配置**:
   - 修改 `frontend/src/config/api.js`
   - 更新生产环境API地址

2. **更新组件API调用**:
   - 修改所有组件的API调用
   - 使用统一的API配置

3. **配置环境变量**:
   - 创建 `.env.production` 文件
   - 设置正确的API地址

4. **部署到Vercel**:
   ```bash
   cd frontend
   npm run build
   vercel --prod
   ```

### 5.3 验证部署

1. **后端验证**:
   - 访问健康检查接口
   - 测试主要API端点
   - 检查数据库连接

2. **前端验证**:
   - 访问部署的前端地址
   - 测试时间轴功能
   - 测试时光胶囊功能
   - 验证错误处理机制

3. **集成测试**:
   - 测试前后端通信
   - 验证CORS配置
   - 测试文件上传功能

## 6. 监控和维护

### 6.1 日志监控

- Railway提供内置日志查看
- 监控API响应时间
- 检查错误日志

### 6.2 备份策略

1. **数据库备份**:
   - 定期下载SQLite文件
   - 使用Git版本控制

2. **媒体文件备份**:
   - 定期备份uploads目录
   - 考虑使用云存储服务

### 6.3 扩展建议

1. **数据库升级**:
   - 考虑迁移到PostgreSQL
   - 使用Railway提供的数据库服务

2. **文件存储优化**:
   - 集成云存储服务(AWS S3, Cloudinary)
   - 优化媒体文件处理

3. **性能优化**:
   - 添加缓存机制
   - 优化API响应时间
   - 实现CDN加速

## 7. 故障排除

### 7.1 常见问题

1. **CORS错误**:
   - 检查Flask-CORS配置
   - 确认前端域名在允许列表中

2. **数据库连接失败**:
   - 检查SQLite文件权限
   - 验证数据库初始化

3. **API调用失败**:
   - 检查网络连接
   - 验证API地址配置
   - 查看后端日志

### 7.2 调试步骤

1. **后端调试**:
   ```bash
   # 查看Railway日志
   railway logs
   
   # 本地测试
   python app.py
   ```

2. **前端调试**:
   ```bash
   # 检查构建
   npm run build
   
   # 本地预览
   npm run preview
   ```

## 8. 安全考虑

### 8.1 环境变量安全

- 不要在代码中硬编码敏感信息
- 使用平台提供的环境变量管理
- 定期轮换API密钥

### 8.2 API安全

- 实现请求频率限制
- 添加输入验证
- 使用HTTPS通信

### 8.3 文件上传安全

- 限制文件类型和大小
- 扫描恶意文件
- 使用安全的文件存储路径

---

通过以上完整的部署方案，时光轴笔记本项目可以在生产环境中稳定运行，解决了Vercel仅支持前端部署的限制问